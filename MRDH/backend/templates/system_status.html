{% extends "base.html" %}

{% block title %}System Status - Navigation System Admin{% endblock %}

{% block extra_css %}
<style>
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}

.status-online { background-color: var(--success-color); }
.status-warning { background-color: var(--warning-color); }
.status-offline { background-color: var(--danger-color); }

.metric-card {
    background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.9));
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 20px;
    border: 1px solid rgba(0,0,0,0.05);
    transition: all 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.metric-value {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 10px 0;
}

.metric-label {
    color: #6B7280;
    font-size: 0.9rem;
    font-weight: 500;
}

.health-score {
    font-size: 3rem;
    font-weight: 800;
    background: linear-gradient(135deg, var(--success-color), #2ABF88);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.log-entry {
    border-left: 4px solid #E5E7EB;
    padding: 12px 16px;
    margin-bottom: 8px;
    background: rgba(255,255,255,0.8);
    border-radius: 8px;
    transition: all 0.3s ease;
}

.log-entry.error { border-left-color: var(--danger-color); }
.log-entry.warning { border-left-color: var(--warning-color); }
.log-entry.info { border-left-color: var(--primary-color); }
.log-entry.success { border-left-color: var(--success-color); }

.log-entry:hover {
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.service-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.service-card {
    background: rgba(255,255,255,0.9);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    border: 1px solid rgba(0,0,0,0.05);
    transition: all 0.3s ease;
}

.service-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}

.performance-chart {
    height: 200px;
    margin: 20px 0;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-server me-2"></i>
                    System Status
            </h1>
            <div>
                <span class="badge bg-success me-2">
                    <span class="status-indicator status-online"></span>
                    System Running Normally
                </span>
                <button class="btn btn-primary" onclick="refreshStatus()">
                    <i class="fas fa-sync me-2"></i>
                    Refresh Status
                </button>
            </div>
        </div>
    </div>
</div>

<!-- System Health Overview -->
<div class="row mb-4">
    <div class="col-lg-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="health-score" id="healthScore">98</div>
                <h6 class="text-muted">System Health</h6>
                <div class="progress mt-3" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: 98%"></div>
                </div>
                <small class="text-success mt-2 d-block">
                    <i class="fas fa-arrow-up me-1"></i>
                    Compared to yesterday +2%
                </small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-9">
        <div class="row">
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <i class="fas fa-microchip fa-2x text-primary mb-2"></i>
                    <div class="metric-value text-primary" id="cpuUsage">--</div>
                    <div class="metric-label">CPU Usage</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <i class="fas fa-memory fa-2x text-info mb-2"></i>
                    <div class="metric-value text-info" id="memoryUsage">--</div>
                    <div class="metric-label">Memory Usage</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <i class="fas fa-hdd fa-2x text-warning mb-2"></i>
                    <div class="metric-value text-warning" id="diskUsage">--</div>
                    <div class="metric-label">Disk Usage</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <i class="fas fa-network-wired fa-2x text-success mb-2"></i>
                    <div class="metric-value text-success" id="networkStatus">Normal</div>
                    <div class="metric-label">Network Status</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Service Status -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Core Service Status
                </h5>
            </div>
            <div class="card-body">
                <div class="service-grid">
                    <div class="service-card">
                        <i class="fas fa-flask fa-2x text-primary mb-3"></i>
                        <h6>Flask Application</h6>
                        <div>
                            <span class="status-indicator status-online"></span>
                            <span class="text-success">Running</span>
                        </div>
                        <small class="text-muted d-block mt-2">
                            Port: 5000 | Uptime: <span id="flaskUptime">--</span>
                        </small>
                    </div>
                    
                    <div class="service-card">
                        <i class="fas fa-volume-up fa-2x text-success mb-3"></i>
                        <h6>Voice Service</h6>
                        <div>
                            <span class="status-indicator status-online"></span>
                            <span class="text-success">Normal</span>
                        </div>
                        <small class="text-muted d-block mt-2">
                            Engine: pyttsx3 | Cache: <span id="voiceCacheCount">--</span> files
                        </small>
                    </div>
                    
                    <div class="service-card">
                        <i class="fas fa-map fa-2x text-info mb-3"></i>
                        <h6>Map Service</h6>
                        <div>
                            <span class="status-indicator status-online"></span>
                            <span class="text-success">Normal</span>
                        </div>
                        <small class="text-muted d-block mt-2">
                            Maps: <span id="mapCount">--</span> | Last Update: <span id="lastMapUpdate">--</span>
                        </small>
                    </div>
                    
                    <div class="service-card">
                        <i class="fas fa-route fa-2x text-warning mb-3"></i>
                        <h6>Navigation Service</h6>
                        <div>
                            <span class="status-indicator status-online"></span>
                            <span class="text-success">Normal</span>
                        </div>
                        <small class="text-muted d-block mt-2">
                            Today's Requests: <span id="todayNavRequests">--</span> | Success Rate: <span id="navSuccessRate">--</span>%
                        </small>
                    </div>
                    
                    <div class="service-card">
                        <i class="fas fa-database fa-2x text-primary mb-3"></i>
                        <h6>Data Storage</h6>
                        <div>
                            <span class="status-indicator status-online"></span>
                            <span class="text-success">Normal</span>
                        </div>
                        <small class="text-muted d-block mt-2">
                            Type: JSON Files | Size: <span id="dataSize">--</span> MB
                        </small>
                    </div>
                    
                    <div class="service-card">
                        <i class="fas fa-shield-alt fa-2x text-success mb-3"></i>
                        <h6>Security Status</h6>
                        <div>
                            <span class="status-indicator status-online"></span>
                            <span class="text-success">Secure</span>
                        </div>
                        <small class="text-muted d-block mt-2">
                            CORS: Configured | Local Run: Secure
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance charts and system logs -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Performance Monitoring
                </h5>
            </div>
            <div class="card-body">
                <div class="performance-chart">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    System Warning
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <small>
                        <i class="fas fa-clock me-1"></i>
                        It is recommended to regularly clean up voice cache to free up disk space
                    </small>
                </div>
                <div class="alert alert-info">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        The system is running stably, all services are Normal
                    </small>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tools me-2"></i>
                    Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="restartServices()">
                        <i class="fas fa-redo me-2"></i>
                        Restart Services
                    </button>
                    <button class="btn btn-outline-warning" onclick="clearLogs()">
                        <i class="fas fa-trash me-2"></i>
                        Clear Logs
                    </button>
                    <button class="btn btn-outline-success" onclick="exportSystemInfo()">
                        <i class="fas fa-download me-2"></i>
                        Export System Info
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Logs -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-alt me-2"></i>
                    System Logs
                </h5>
                <div>
                    <select class="form-select form-select-sm d-inline-block w-auto me-2" id="logLevel">
                        <option value="">All Levels</option>
                        <option value="error">Error</option>
                        <option value="warning">Warning</option>
                        <option value="info">Info</option>
                    </select>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div style="max-height: 400px; overflow-y: auto;" id="systemLogs">
                    <div class="log-entry info">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>[INFO]</strong> System started successfully
                            </div>
                            <small class="text-muted">2024-01-15 10:30:25</small>
                        </div>
                        <small class="text-muted">Flask application started on port 5000</small>
                    </div>
                    
                    <div class="log-entry success">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>[SUCCESS]</strong> Voice service initialization completed
                            </div>
                            <small class="text-muted">2024-01-15 10:30:26</small>
                        </div>
                        <small class="text-muted">pyttsx3 engine is ready, available voices: 2</small>
                    </div>
                    
                    <div class="log-entry info">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>[INFO]</strong> Map data loaded successfully
                            </div>
                            <small class="text-muted">2024-01-15 10:30:27</small>
                        </div>
                        <small class="text-muted">1 map file loaded</small>
                    </div>
                    
                    <div class="log-entry warning">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>[WARNING]</strong> Voice cache directory occupies a large amount of space
                            </div>
                            <small class="text-muted">2024-01-15 10:35:12</small>
                        </div>
                        <small class="text-muted">It is recommended to clean up cache files older than 7 days</small>
                    </div>
                    
                    <div class="log-entry info">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>[INFO]</strong> Received navigation request
                            </div>
                            <small class="text-muted">2024-01-15 10:45:33</small>
                        </div>
                        <small class="text-muted">Map ID: 1, Target room: 101</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Mock system status data
let systemMetrics = {
    cpu: 0,
    memory: 0,
    disk: 0,
    network: 'online'
};

// Performance chart
let performanceChart;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initPerformanceChart();
    updateSystemMetrics();
    setInterval(updateSystemMetrics, 5000); // Update every 5 seconds
});

function initPerformanceChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    
    // Generate simulated data for the past 24 hours
    const now = new Date();
    const labels = [];
    const cpuData = [];
    const memoryData = [];
    
    for (let i = 23; i >= 0; i--) {
        const time = new Date(now.getTime() - i * 60 * 60 * 1000);
        labels.push(time.getHours() + ':00');
        cpuData.push(Math.random() * 50 + 10); // 10-60%
        memoryData.push(Math.random() * 40 + 30); // 30-70%
    }
    
    performanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'CPU Usage (%)',
                data: cpuData,
                borderColor: 'rgb(46, 139, 255)',
                backgroundColor: 'rgba(46, 139, 255, 0.1)',
                tension: 0.4
            }, {
                label: 'Memory Usage (%)',
                data: memoryData,
                borderColor: 'rgb(54, 211, 153)',
                backgroundColor: 'rgba(54, 211, 153, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                }
            }
        }
    });
}

function updateSystemMetrics() {
    // Get system status information (using the existing status interface)
    fetch('/api/system/status')
    .then(response => response.json())
    .then(data => {
        if (data.code === 200) {
            const status = data.data;
            const resources = status.system_resources || {};
            
            // Update resource usage
            updateMetricDisplay('cpuUsage', resources.cpu_percent || 0, '%');
            updateMetricDisplay('memoryUsage', resources.memory_percent || 0, '%');
            updateMetricDisplay('diskUsage', resources.disk_percent || 0, '%');
            
            // Update other statistics
            document.getElementById('flaskUptime').textContent = status.uptime_formatted || '--';
            document.getElementById('voiceCacheCount').textContent = status.voice_files_cached || '--';
            document.getElementById('mapCount').textContent = status.maps_count || '--';
            document.getElementById('lastMapUpdate').textContent = '--'; // 暂无此字段
            document.getElementById('todayNavRequests').textContent = status.navigation_requests_today || '--';
            document.getElementById('navSuccessRate').textContent = '100%'; // 暂无此字段，默认100%
            document.getElementById('dataSize').textContent = status.disk_usage?.total_app_size || '--';
            
            // Update health score
            const healthScore = calculateHealthScore(status);
            document.getElementById('healthScore').textContent = healthScore;
        }
    })
    .catch(error => {
        console.error('Failed to get system metrics:', error);
        // Use mock data
        updateWithMockData();
    });
}

function updateWithMockData() {
    // Generate mock data
    const cpu = Math.random() * 30 + 10; // 10-40%
    const memory = Math.random() * 20 + 40; // 40-60%
    const disk = Math.random() * 10 + 20; // 20-30%
    
    updateMetricDisplay('cpuUsage', cpu, '%');
    updateMetricDisplay('memoryUsage', memory, '%');
    updateMetricDisplay('diskUsage', disk, '%');
    
    // Mock other data
    document.getElementById('flaskUptime').textContent = '2 hours 45 minutes';
    document.getElementById('voiceCacheCount').textContent = '28';
    document.getElementById('mapCount').textContent = '1';
    document.getElementById('lastMapUpdate').textContent = '1 hour ago';
    document.getElementById('todayNavRequests').textContent = '15';
    document.getElementById('navSuccessRate').textContent = '96.7';
    document.getElementById('dataSize').textContent = '2.1';
    
    const healthScore = Math.round(100 - (cpu + memory + disk) / 3);
    document.getElementById('healthScore').textContent = Math.max(healthScore, 85);
}

function updateMetricDisplay(elementId, value, unit) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = Math.round(value) + unit;
        
        // Update color based on value
        if (value > 80) {
            element.className = 'metric-value text-danger';
        } else if (value > 60) {
            element.className = 'metric-value text-warning';
        } else {
            element.className = 'metric-value text-success';
        }
    }
}

function calculateHealthScore(status) {
    const resources = status.system_resources || {};
    const cpu = resources.cpu_percent || 0;
    const memory = resources.memory_percent || 0;
    const disk = resources.disk_percent || 0;
    
    // Simple health score calculation
    const avgUsage = (cpu + memory + disk) / 3;
    
    // Calculate health score based on system status and resource usage
    let baseScore = Math.max(Math.round(100 - avgUsage), 60);
    
    // If the system status is healthy, add points
    if (status.status === 'healthy') {
        baseScore = Math.min(baseScore + 10, 100);
    }
    
    return baseScore;
}

function refreshStatus() {
    updateSystemMetrics();
    refreshLogs();
}

function refreshLogs() {
    // Here you can call the API to refresh the logs
    console.log('Refresh system logs...');
}

function restartServices() {
    if (confirm('Are you sure you want to restart all services? This may interrupt the current navigation request.')) {
        alert('Service restart functionality is under development...');
    }
}

function clearLogs() {
    if (confirm('Are you sure you want to clear the system logs?')) {
        alert('Log clearing functionality is under development...');
    }
}

function exportSystemInfo() {
    alert('System information export functionality is under development...');
}

// Log filtering
document.getElementById('logLevel').addEventListener('change', function() {
    const level = this.value;
    const logEntries = document.querySelectorAll('.log-entry');
    
    logEntries.forEach(entry => {
        if (!level || entry.classList.contains(level)) {
            entry.style.display = 'block';
        } else {
            entry.style.display = 'none';
        }
    });
});

// Update mock data when starting
updateWithMockData();
</script>
{% endblock %}
