{% extends "base.html" %}

{% block title %}Map Management - Navigation System Admin Backend{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-map me-2"></i>
                Map Management
            </h1>
            <div>
                <button class="btn btn-primary" onclick="refreshMaps()">
                    <i class="fas fa-sync me-2"></i>
                    Refresh
                </button>
                <a href="{{ url_for('main.map_editor') }}" class="btn btn-success">
                    <i class="fas fa-plus me-2"></i>
                    Create New Map
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card card-stat h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title text-muted">Total Maps</h6>
                        <h2 class="text-primary" id="totalMaps">{{ maps|length }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-map fa-2x text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card card-stat h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title text-muted">Available Maps</h6>
                        <h2 class="text-success" id="availableMaps">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card card-stat h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title text-muted">Total Rooms</h6>
                        <h2 class="text-info" id="totalRooms">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-door-open fa-2x text-info"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card card-stat h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title text-muted">Average Size</h6>
                        <h6 class="text-warning" id="avgSize">-</h6>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-expand-arrows-alt fa-2x text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search map name or ID...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="statusFilter">
                            <option value="">All Status</option>
                            <option value="available">Available</option>
                            <option value="incomplete">Incomplete</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="sortBy">
                            <option value="created_desc">Created Time (Newest First)</option>
                            <option value="created_asc">Created Time (Oldest First)</option>
                            <option value="name_asc">Name (A-Z)</option>
                            <option value="name_desc">Name (Z-A)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Map List -->
<div class="row" id="mapsList">
    {% for map in maps %}
    <div class="col-lg-6 col-xl-4 mb-4 map-item" data-map-id="{{ map.id }}" data-map-name="{{ map.name|lower }}">
        <div class="card h-100">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="card-title mb-1">{{ map.name }}</h5>
                        <small class="text-muted">ID: {{ map.id }}</small>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteMap({{ map.id }})">
                                <i class="fas fa-trash me-2"></i>Delete
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-6">
                        <small class="text-muted">Size</small>
                        <div class="fw-semibold">{{ map.width }} × {{ map.height }}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Room Count</small>
                        <div class="fw-semibold">{{ map.rooms|length if map.rooms else 0 }} rooms</div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <small class="text-muted">Entrance Position</small>
                        <div class="fw-semibold">
                            {% if map.entrance and map.entrance.get('x') is not none and map.entrance.get('y') is not none %}
                            ({{ map.entrance.x }}, {{ map.entrance.y }})
                            {% else %}
                            Not Set
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <small class="text-muted">Status</small>
                    <div>
                        {% if map.entrance and map.entrance.get('x') is not none and map.entrance.get('y') is not none %}
                        <span class="badge bg-success">Available</span>
                        {% else %}
                        <span class="badge bg-warning">Incomplete</span>
                        {% endif %}
                    </div>
                </div>

                <div class="mb-3">
                    <small class="text-muted">Map Information</small>
                    <div class="mt-2 p-3 bg-light rounded">
                        <div class="text-center text-muted">
                            <i class="fas fa-map me-2"></i>
                            Map {{ map.id }} - {{ map.name }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer text-muted">
                <small>
                    <i class="fas fa-clock me-1"></i>
                    Created: {{ map.created_at if map.created_at else 'Unknown' }}
                </small>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Empty State -->
<div class="row" id="emptyState" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-map fa-3x text-muted mb-3"></i>
                <h4>No Maps Yet</h4>
                <p class="text-muted">No maps have been created yet. Start creating your first map now!</p>
                <a href="{{ url_for('main.map_editor') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>
                    Create New Map
                </a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Search functionality
document.getElementById('searchInput').addEventListener('input', filterMaps);
document.getElementById('statusFilter').addEventListener('change', filterMaps);
document.getElementById('sortBy').addEventListener('change', sortMaps);

function filterMaps() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const mapItems = document.querySelectorAll('.map-item');
    let visibleCount = 0;

    mapItems.forEach(item => {
        const mapName = item.dataset.mapName;
        const mapId = item.dataset.mapId;
        const statusBadge = item.querySelector('.badge');
        const status = statusBadge ? (statusBadge.classList.contains('bg-success') ? 'available' : 'incomplete') : 'incomplete';

        const matchesSearch = mapName.includes(searchTerm) || mapId.includes(searchTerm);
        const matchesStatus = !statusFilter || status === statusFilter;

        if (matchesSearch && matchesStatus) {
            item.style.display = 'block';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });

    // Show or hide empty state
    document.getElementById('emptyState').style.display = visibleCount === 0 ? 'block' : 'none';
    document.getElementById('mapsList').style.display = visibleCount === 0 ? 'none' : 'flex';
}

function sortMaps() {
    const sortBy = document.getElementById('sortBy').value;
    const mapsList = document.getElementById('mapsList');
    const mapItems = Array.from(mapsList.querySelectorAll('.map-item'));

    mapItems.sort((a, b) => {
        switch (sortBy) {
            case 'name_asc':
                return a.dataset.mapName.localeCompare(b.dataset.mapName);
            case 'name_desc':
                return b.dataset.mapName.localeCompare(a.dataset.mapName);
            case 'created_asc':
            case 'created_desc':
                // Here you can sort by actual creation time field
                return sortBy === 'created_desc' ? -1 : 1;
            default:
                return 0;
        }
    });

    mapItems.forEach(item => mapsList.appendChild(item));
}

function refreshMaps() {
    location.reload();
}

function deleteMap(mapId) {
    if (confirm('Are you sure you want to delete this map? This action cannot be undone.')) {
        fetch(`/api/maps/${mapId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.code === 200) {
                alert('Map deleted successfully');
                location.reload();
            } else {
                alert(`Delete failed: ${data.message}`);
            }
        })
        .catch(error => {
            alert(`Delete failed: ${error.message}`);
        });
    }
}


// Calculate statistics
document.addEventListener('DOMContentLoaded', function() {
    const mapItems = document.querySelectorAll('.map-item');
    let availableCount = 0;
    let totalRooms = 0;
    let totalArea = 0;

    mapItems.forEach(item => {
        const statusBadge = item.querySelector('.badge');
        if (statusBadge && statusBadge.classList.contains('bg-success')) {
            availableCount++;
        }

        // Get room count (second .fw-semibold element)
        const roomElements = item.querySelectorAll('.card-body .fw-semibold');
        if (roomElements.length >= 2) {
            const roomCountText = roomElements[1].textContent;
            const roomCount = parseInt(roomCountText.split(' ')[0]) || 0;
            totalRooms += roomCount;
        }

        // Get map size (first .fw-semibold element)
        if (roomElements.length >= 1) {
            const sizeText = roomElements[0].textContent;
            const sizeParts = sizeText.split(' × ');
            if (sizeParts.length === 2) {
                const width = parseInt(sizeParts[0]) || 0;
                const height = parseInt(sizeParts[1]) || 0;
                totalArea += width * height;
            }
        }
    });

    document.getElementById('availableMaps').textContent = availableCount;
    document.getElementById('totalRooms').textContent = totalRooms;
    
    if (mapItems.length > 0) {
        const avgArea = Math.round(totalArea / mapItems.length);
        const avgWidth = Math.round(Math.sqrt(avgArea));
        const avgHeight = Math.round(avgArea / avgWidth);
        document.getElementById('avgSize').textContent = `${avgWidth}×${avgHeight}`;
    }
});
</script>
{% endblock %}
